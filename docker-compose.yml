version: '3.8'

services:
  nginx:
    container_name: nginx
    depends_on:
      - interfaccia-progetto
      - archiver
    restart: always
    build:
      dockerfile: Dockerfile
      context: ./nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf:/etc/nginx
      - ./nginx/certs/:/etc/nginx/certs/

  interfaccia-progetto:
    container_name: interfaccia-progetto
    stdin_open: true
    build:
      dockerfile: Dockerfile
      context: ./interfaccia-progetto/
    environment:
      - AWS_COGNITO_USERPOOL_ID=eu-north-1_3xHlO3KO2
      - AWS_COGNITO_CLIENT_ID=2pvlparps5taordhs5ok5tonp8
    volumes:
      - /interfaccia-progetto/node_modules
      - ./interfaccia-progetto:/progetto

  archiver:
    container_name: archiver-car-charger
    build:
      dockerfile: Dockerfile
      context: ./archiver-car-charger/
    environment:
      - RDS_PORT=5432
      - RDS_HOSTNAME=database-2.cm1nefxysi9s.eu-north-1.rds.amazonaws.com
      - POSTGRESQL_DB_USER=postgres
      - POSTGRESQL_DB_PASSWORD=admin123
      - RDS_NAME=carcharger
      - AWS_COGNITO_USERPOOL_ID=eu-north-1_3xHlO3KO2
      - AWS_COGNITO_CLIENT_ID=2pvlparps5taordhs5ok5tonp8
    volumes:
      - /archiver/node_modules
      - ./archiver-car-charger:/archiver
  
  mosquitto:
    container_name: mosquitto-aws
    image: eclipse-mosquitto:latest
    build:
      dockerfile: Dockerfile
      context: ./broker/
    volumes:
    - ./broker/config:/mosquitto/config/
    #- ./broker/data:/mosquitto/data/
    #- ./broker/log:/mosquitto/log/ 
    ports:
      - '8883:8883'
      - '1883:1883'
    restart: always
    
